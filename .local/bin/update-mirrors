#!/bin/sh
# update mirrors and database

CONCURRENCY=12
MAX_DELAY=43200
PER_MIRROR_TIMEOUT=1000
TOP_MIRRORS_NUMBER_TO_RETEST=10

ARCH_RESULTS=$(mktemp)
CHAOTIC_RESULTS=$(mktemp)

notify-send -t 3000 "Update Mirrors" "Testing Arch mirrors..."

rate-mirrors \
	--concurrency "$CONCURRENCY" \
	--per-mirror-timeout "$PER_MIRROR_TIMEOUT" \
	--top-mirrors-number-to-retest "$TOP_MIRRORS_NUMBER_TO_RETEST" \
	--save "$ARCH_RESULTS" \
	arch \
	--max-delay "$MAX_DELAY" &&
	notify-send -t 3000 "Update Mirrors" "Testing Chaotic mirrors..."

rate-mirrors \
	--concurrency "$CONCURRENCY" \
	--per-mirror-timeout "$PER_MIRROR_TIMEOUT" \
	--top-mirrors-number-to-retest "$TOP_MIRRORS_NUMBER_TO_RETEST" \
	--save "$CHAOTIC_RESULTS" \
	chaotic-aur &&
	notify-send -t 3000 "Update Mirrors" "Doas authentication required"

{
	mv /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist-backup &&
		mv "$ARCH_RESULTS" /etc/pacman.d/mirrorlist
	mv /etc/pacman.d/chaotic-mirrorlist /etc/pacman.d/chaotic-mirrorlist-backup &&
		mv "$CHAOTIC_RESULTS" /etc/pacman.d/chaotic-mirrorlist
} &&
	paru -Syy
