#!/bin/sh
JSON="/tmp/low-battery.json"

acpi --battery |
	rg '^Battery 0: (?P<status>\w+), (?P<percent>\d+)%, (?P<hours>\d+):(?P<minutes>\d+)' \
		-o -r '{
  "status":  "$status",
  "percent": "$percent",
  "hours":   "$hours",
  "minutes": "$minutes"
}' >"$JSON"

STATUS=$(jql -r '"status"' "$JSON")
PERCENT=$(jql -r '"percent"' "$JSON")
HOURS=$(jql -r '"hours"' "$JSON")
MINUTES=$(jql -r '"minutes"' "$JSON")

if [ "$STATUS" = "Discharging" ]; then
	if [ "$PERCENT" -lt "30" ]; then
		if [ "$HOURS" -gt "0" ]; then
			MSG_HOURS="${HOURS}h"
		fi
		if [ "$MINUTES" -gt "0" ]; then
			MSG_MINUTES="${MINUTES}m"
		fi
		if [ "$HOURS" -gt "0" ] && [ "$MINUTES" -gt "0" ]; then
			MSG_AND=" and "
		fi
		LOW_BAT_MSG="$MSG_HOURS$MSG_AND$MSG_MINUTES remaining"

		notify-send \
			--urgency critical \
			--expire-time 20000 \
			"LOW BATTERY" \
			"$LOW_BAT_MSG"
	fi
fi
